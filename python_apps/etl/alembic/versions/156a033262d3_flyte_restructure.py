"""Flyte restructure

Revision ID: 156a033262d3
Revises: a767fb5c16fa
Create Date: 2024-06-03 14:29:40.119358

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "156a033262d3"
down_revision: Union[str, None] = "a767fb5c16fa"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table("pipeline_step_deps")
    op.execute("DROP TABLE applications CASCADE")
    op.execute("DROP TABLE pipeline_steps CASCADE")
    op.drop_table("pipeline_step_data")
    op.add_column("configurations", sa.Column("pipelineId", sa.Uuid(), nullable=True))
    op.execute('UPDATE configurations SET "pipelineId" = (raw->>\'selectedPipelineId\')::uuid WHERE "pipelineId" is null')
    op.alter_column("configurations", "pipelineId", existing_type=sa.Uuid(), nullable=False)
    op.add_column("configurations", sa.Column("datasetId", sa.Uuid(), nullable=True))
    op.execute('UPDATE configurations SET "datasetId" = (raw->>\'datasetId\')::uuid WHERE "datasetId" is null')
    op.alter_column("configurations", "datasetId", existing_type=sa.Uuid(), nullable=False)
    op.create_foreign_key(None, "configurations", "pipelines", ["pipelineId"], ["id"])
    op.create_foreign_key(None, "configurations", "datasets", ["datasetId"], ["id"])
    op.alter_column(
        "instance_pipeline_step_statuses",
        "stepId",
        existing_type=sa.UUID(),
        type_=sa.String(),
        existing_nullable=False,
    )
    op.add_column("instances", sa.Column("pipelineId", sa.Uuid(), nullable=True))
    op.execute('UPDATE instances SET "pipelineId" = "selectedPipelineId" WHERE "pipelineId" is null')
    op.alter_column("instances", "pipelineId", existing_type=sa.Uuid(), nullable=False)
    op.alter_column(
        "instances",
        "configurationRaw",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
    )
    op.drop_constraint("instances_selectedPipelineId_fkey", "instances", type_="foreignkey")
    op.drop_constraint("instances_datasetId_fkey", "instances", type_="foreignkey")
    op.create_foreign_key(None, "instances", "pipelines", ["pipelineId"], ["id"])
    op.drop_column("instances", "datasetId")
    op.drop_column("instances", "selectedPipelineId")
    op.add_column("pipelines", sa.Column("name", sa.String(), nullable=True))
    op.execute('UPDATE pipelines SET "name" = \'\' WHERE "name" is null')
    op.alter_column("pipelines", "name", existing_type=sa.String(), nullable=False)
    op.add_column("pipelines", sa.Column("flyte_name", sa.String(), nullable=True))
    op.execute('UPDATE pipelines SET "flyte_name" = \'\' WHERE "flyte_name" is null')
    op.alter_column("pipelines", "flyte_name", existing_type=sa.String(), nullable=False)
    op.add_column("pipelines", sa.Column("input", sa.String(), nullable=True))
    op.execute('UPDATE pipelines SET "input" = \'\' WHERE "input" is null')
    op.alter_column("pipelines", "input", existing_type=sa.String(), nullable=False)
    op.drop_column("pipelines", "entry")
    op.drop_column("pipelines", "exit")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "applications",
        sa.Column(
            "id",
            sa.INTEGER(),
            server_default=sa.text("nextval('applications_id_seq'::regclass)"),
            autoincrement=True,
            nullable=False,
        ),
        sa.Column("title", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("icon", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("description", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("version", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("creator", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column(
            "applicationType",
            postgresql.ENUM("INGEST", "PREPROCESS", name="applicationtype"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name="applications_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_table(
        "pipeline_steps",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("title", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("pipelineId", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(["pipelineId"], ["pipelines.id"], name="FKPipelineStepPipeline"),
        sa.PrimaryKeyConstraint("id", name="pipeline_steps_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_table(
        "pipeline_step_deps",
        sa.Column("source_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("target_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["source_id"],
            ["pipeline_steps.id"],
            name="pipeline_step_deps_source_id_fkey",
        ),
        sa.ForeignKeyConstraint(
            ["target_id"],
            ["pipeline_steps.id"],
            name="pipeline_step_deps_target_id_fkey",
        ),
    )
    op.alter_column(
        "instance_pipeline_step_statuses",
        "stepId",
        existing_type=sa.VARCHAR(),
        type_=sa.Uuid(),
        existing_nullable=False,
        postgresql_using='"stepId"::uuid',
    )
    op.add_column("pipelines", sa.Column("exit", sa.UUID(), autoincrement=False, nullable=True))
    # op.add_column(
    #     "pipelines",
    #     sa.Column("applicationId", sa.INTEGER(), autoincrement=False, nullable=True),
    # )
    op.add_column("pipelines", sa.Column("entry", sa.UUID(), autoincrement=False, nullable=True))
    op.create_foreign_key(
        "pipelines_applicationId_fkey",
        "pipelines",
        "applications",
        ["applicationId"],
        ["id"],
    )
    op.create_foreign_key("pipelines_entry_fkey", "pipelines", "pipeline_steps", ["entry"], ["id"])
    op.create_foreign_key("pipelines_exit_fkey", "pipelines", "pipeline_steps", ["exit"], ["id"])
    op.drop_column("pipelines", "input")
    op.drop_column("pipelines", "flyte_name")
    op.drop_column("pipelines", "name")
    op.add_column(
        "instances",
        sa.Column("selectedPipelineId", sa.UUID(), autoincrement=False, nullable=True),
    )
    # op.add_column(
    #     "instances",
    #     sa.Column("applicationId", sa.INTEGER(), autoincrement=False, nullable=True),
    # )
    op.add_column(
        "instances",
        sa.Column("datasetId", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.drop_constraint("instances_pipelineId_fkey", "instances", type_="foreignkey")
    op.create_foreign_key("instances_datasetId_fkey", "instances", "datasets", ["datasetId"], ["id"])
    op.create_foreign_key(
        "instances_applicationId_fkey",
        "instances",
        "applications",
        ["applicationId"],
        ["id"],
    )
    op.create_foreign_key(
        "instances_selectedPipelineId_fkey",
        "instances",
        "pipelines",
        ["selectedPipelineId"],
        ["id"],
    )
    op.alter_column(
        "instances",
        "configurationRaw",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=postgresql.JSON(astext_type=sa.Text()),
        nullable=True,
    )
    op.drop_column("instances", "pipelineId")
    op.create_foreign_key(
        "instance_pipeline_step_statuses_stepId_fkey",
        "instance_pipeline_step_statuses",
        "pipeline_steps",
        ["stepId"],
        ["id"],
    )
    # op.add_column(
    #     "configurations",
    #     sa.Column("applicationId", sa.INTEGER(), autoincrement=False, nullable=False),
    # )
    op.drop_constraint("configurations_pipelineId_fkey", "configurations", type_="foreignkey")
    op.drop_constraint("configurations_datasetId_fkey", "configurations", type_="foreignkey")
    op.create_foreign_key(
        "configurations_applicationId_fkey",
        "configurations",
        "applications",
        ["applicationId"],
        ["id"],
    )
    op.drop_column("configurations", "datasetId")
    op.drop_column("configurations", "pipelineId")
    op.create_table(
        "pipeline_step_data",
        sa.Column("stepId", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("title", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("value", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.ForeignKeyConstraint(["stepId"], ["pipeline_steps.id"], name="pipeline_step_data_stepId_fkey"),
        sa.PrimaryKeyConstraint("stepId", name="pipeline_step_data_pkey"),
    )
    # ### end Alembic commands ###
