# Elevaite Platform - Local Development Environment
# Usage: docker-compose -f docker-compose.dev.yaml up -d
# Or simply: npm run dev

# Load environment variables from .env file (create from .env.example)
# Contains: OPENAI_API_KEY, GEMINI_API_KEY, GOOGLE_CLIENT_ID, etc.

volumes:
  postgres_data:
  qdrant_data:
  rabbitmq_data:
  minio_data:

services:
  # ============================================================
  # INFRASTRUCTURE
  # ============================================================

  postgres:
    image: postgres:15-alpine
    container_name: elevaite-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: elevaite
      POSTGRES_PASSWORD: elevaite
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U elevaite"]
      interval: 3s
      timeout: 3s
      retries: 10

  qdrant:
    image: qdrant/qdrant:latest
    container_name: elevaite-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 sh -c '</dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  rabbitmq:
    image: rabbitmq:3-management
    container_name: elevaite-rabbitmq
    ports:
      - "5672:5672"    # AMQP protocol
      - "15672:15672"  # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: elevaite
      RABBITMQ_DEFAULT_PASS: elevaite
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  minio:
    image: minio/minio:latest
    container_name: elevaite-minio
    ports:
      - "9000:9000"    # S3 API
      - "9001:9001"    # Console UI
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ============================================================
  # BACKEND SERVICES
  # ============================================================

  auth-api:
    build:
      context: .
      dockerfile: python_apps/auth_api/Dockerfile
    container_name: elevaite-auth-api
    ports:
      - "8004:8004"
    env_file:
      - .env
    environment:
      SQLALCHEMY_DATABASE_URL: postgresql+asyncpg://elevaite:elevaite@postgres:5432/auth
      DEBUG: "1"
      LOG_LEVEL: DEBUG
      CORS_ORIGINS: "http://localhost:3005,http://localhost:3001"
      # OPA disabled for local dev - all authorization checks will pass
      OPA_ENABLED: "false"
      # Allow requests from Docker service names (workflow-engine, worker call auth-api internally)
      ALLOWED_HOSTS: "localhost,127.0.0.1,auth-api"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/api/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  workflow-engine:
    build:
      context: .
      dockerfile: python_apps/workflow-engine-poc/Dockerfile
    container_name: elevaite-workflow-engine
    ports:
      - "8006:8006"
    env_file:
      - .env
    environment:
      # Use psycopg2 (sync) driver - workflow-engine uses sync SQLAlchemy sessions
      SQLALCHEMY_DATABASE_URL: postgresql+psycopg2://elevaite:elevaite@postgres:5432/workflow_engine
      INGESTION_SERVICE_URL: http://ingestion:8000
      CODE_EXECUTION_SERVICE_URL: http://code-execution:8007
      AUTHZ_SERVICE_URL: http://auth-api:8004
      LOG_LEVEL: DEBUG
      SCHEDULER_POLL_SECONDS: "2"
      # RabbitMQ for async task queues
      RABBITMQ_URL: amqp://elevaite:elevaite@rabbitmq:5672/
      # MinIO for S3-compatible object storage
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_SECURE: "false"
      # Dummy AWS creds to skip slow EC2 metadata lookup in local dev
      AWS_ACCESS_KEY_ID: "local-dev-key"
      AWS_SECRET_ACCESS_KEY: "local-dev-secret"
      AWS_DEFAULT_REGION: "us-west-1"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      qdrant:
        condition: service_started
      ingestion:
        condition: service_healthy
      code-execution:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  worker:
    build:
      context: .
      dockerfile: python_apps/workflow-engine-poc/Dockerfile
    container_name: elevaite-worker
    command: ["-m", "workflow_engine_poc.worker"]
    env_file:
      - .env
    environment:
      # Use psycopg2 (sync) driver - worker uses sync SQLAlchemy sessions
      SQLALCHEMY_DATABASE_URL: postgresql+psycopg2://elevaite:elevaite@postgres:5432/workflow_engine
      RABBITMQ_URL: amqp://elevaite:elevaite@rabbitmq:5672/
      QDRANT_HOST: qdrant
      QDRANT_PORT: "6333"
      INGESTION_SERVICE_URL: http://ingestion:8000
      CODE_EXECUTION_SERVICE_URL: http://code-execution:8007
      AUTHZ_SERVICE_URL: http://auth-api:8004
      LOG_LEVEL: DEBUG
      # MinIO for S3-compatible object storage
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_SECURE: "false"
      # Dummy AWS creds to skip slow EC2 metadata lookup in local dev
      AWS_ACCESS_KEY_ID: "local-dev-key"
      AWS_SECRET_ACCESS_KEY: "local-dev-secret"
      AWS_DEFAULT_REGION: "us-west-1"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      qdrant:
        condition: service_started
      code-execution:
        condition: service_healthy
    restart: unless-stopped

  ingestion:
    build:
      context: .
      dockerfile: python_apps/ingestion-service/Dockerfile
    container_name: elevaite-ingestion
    ports:
      - "8001:8000"
    environment:
      DATABASE_URL: postgresql+asyncpg://elevaite:elevaite@postgres:5432/elevaite_ingestion
      DBOS_DATABASE_URL: postgresql+asyncpg://elevaite:elevaite@postgres:5432/elevaite_ingestion
      SERVICE_HOST: "0.0.0.0"
      SERVICE_PORT: "8000"
      WORKFLOW_ENGINE_URL: http://workflow-engine:8006
      QDRANT_HOST: qdrant
      QDRANT_PORT: "6333"
      LOG_LEVEL: DEBUG
      # RabbitMQ for async task queues
      RABBITMQ_URL: amqp://elevaite:elevaite@rabbitmq:5672/
      # MinIO for S3-compatible object storage
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_SECURE: "false"
      # Dummy AWS creds to skip slow EC2 metadata lookup in local dev
      AWS_ACCESS_KEY_ID: "local-dev-key"
      AWS_SECRET_ACCESS_KEY: "local-dev-secret"
      AWS_DEFAULT_REGION: "us-west-1"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  code-execution:
    build:
      context: .
      dockerfile: python_apps/code-execution-service/Dockerfile
    container_name: elevaite-code-execution
    ports:
      - "8007:8007"
    environment:
      SERVICE_PORT: "8007"
      LOG_LEVEL: DEBUG
      DEFAULT_TIMEOUT_SECONDS: "30"
      MAX_MEMORY_MB: "256"
      NSJAIL_CONFIG_PATH: /app/nsjail/nsjail.cfg
    # Nsjail requires these capabilities for namespace isolation
    cap_add:
      - SYS_ADMIN
      - SYS_PTRACE
      - NET_ADMIN
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s
