# ElevAIte Helm Chart - Production Environment
# Uses managed services provisioned by Terraform

# =============================================================================
# GLOBAL
# =============================================================================
global:
  imageRegistry: "ghcr.io/iopexses/elevaite"
  environment: "production"

# =============================================================================
# APPLICATION SERVICES
# =============================================================================
authApi:
  replicaCount: 1  # Single replica for cost savings
  image:
    tag: "production"
    pullPolicy: Always
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  env:
    LOG_LEVEL: INFO
    DEBUG: "0"
    ALLOWED_HOSTS: "*"
  envFromSecrets:
    - elevaite-secrets

workflowEngine:
  replicaCount: 1  # Single replica for cost savings
  image:
    tag: "production"
    pullPolicy: Always
  resources:
    requests:
      cpu: 1000m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
  env:
    LOG_LEVEL: INFO
    SCHEDULER_POLL_SECONDS: "3"
    ALLOWED_HOSTS: "*"
  envFromSecrets:
    - elevaite-secrets

ingestion:
  replicaCount: 1  # Single replica for cost savings
  image:
    tag: "production"
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  env:
    LOG_LEVEL: INFO
    ALLOWED_HOSTS: "*"
  envFromSecrets:
    - elevaite-secrets

worker:
  replicaCount: 2  # Reduced workers for cost savings
  image:
    tag: "production"
  resources:
    requests:
      cpu: 1000m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
  env:
    LOG_LEVEL: INFO
  envFromSecrets:
    - elevaite-secrets
  autoscaling:
    enabled: false  # Disabled for cost savings
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# =============================================================================
# INGRESS
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
  hosts:
    - host: api.elevaite.ai
      paths:
        - path: /api/auth
          pathType: Prefix
          service: auth-api
        - path: /
          pathType: Prefix
          service: workflow-engine
  tls:
    - secretName: elevaite-prod-tls
      hosts:
        - api.elevaite.ai

# =============================================================================
# FRONTEND APPS
# =============================================================================
frontend:
  auth:
    enabled: true
    replicaCount: 1
    image:
      tag: "production"
      pullPolicy: Always
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    env: {}
  elevaite:
    enabled: true
    replicaCount: 1
    image:
      tag: "production"
      pullPolicy: Always
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    env: {}

# =============================================================================
# EXTERNAL SERVICES (Managed by Terraform)
# All connection details injected from Terraform outputs
# =============================================================================

# PostgreSQL - AWS RDS / Azure DB / Google Cloud SQL
# Production uses Multi-AZ, larger instance (db.r6g.large or equivalent)
postgresql:
  host: ""  # Set via --set or CI/CD from Terraform output
  port: 5432
  database: "elevaite"
  sslMode: "require"
  existingSecret: "elevaite-db-credentials"

# RabbitMQ - Internal K8s deployment
rabbitmq:
  internal:
    enabled: true
    replicaCount: 1
    auth:
      username: elevaite
      password: "production-rabbitmq-password"  # Override in secrets
      erlangCookie: "production-erlang-cookie"  # Override in secrets
    persistence:
      size: 16Gi
      storageClass: ""  # Use default
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
  port: 5672
  vhost: "/"
  existingSecret: "elevaite-rabbitmq-credentials"

# Object Storage - S3 / GCS / Azure Blob
objectStorage:
  provider: "aws"  # or gcp, azure
  bucket: ""  # Injected by pipeline from Terraform output
  region: "us-west-1"
  existingSecret: "elevaite-storage-credentials"

# Qdrant - Internal K8s deployment
qdrant:
  internal:
    enabled: true
    replicaCount: 1
    persistence:
      size: 20Gi
      storageClass: ""  # Use default
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi

# =============================================================================
# MIGRATIONS (Runs after approval gate in deploy workflow)
# =============================================================================
migrations:
  enabled: true
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  tenants:
    - default
    - toshiba
    - iopex

# =============================================================================
# SERVICE ACCOUNT
# =============================================================================
serviceAccount:
  create: true
  annotations: {}
  # AWS example:
  # annotations:
  #   eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/elevaite-prod-role

# =============================================================================
# POD SETTINGS (Production hardening)
# =============================================================================
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: elevaite
          topologyKey: kubernetes.io/hostname
