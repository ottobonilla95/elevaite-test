# ElevAIte Helm Chart - PR Environment
# Ephemeral environment for pull request testing
# Uses shared dev managed database with database-per-PR isolation

# =============================================================================
# GLOBAL
# =============================================================================
global:
  imageRegistry: "ghcr.io/iopexses/elevaite"
  environment: "pr"

# =============================================================================
# APPLICATION SERVICES (Minimal resources for PR envs)
# =============================================================================
authApi:
  replicaCount: 1
  image:
    tag: "pr"  # Set dynamically: pr-${PR_NUMBER}
    pullPolicy: Always  # Always pull latest image for PR environments
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env:
    LOG_LEVEL: DEBUG
    ALLOWED_HOSTS: "*"
  envFromSecrets:
    - elevaite-secrets

workflowEngine:
  replicaCount: 1
  image:
    tag: "pr"
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 512Mi
  env:
    LOG_LEVEL: DEBUG
    SCHEDULER_POLL_SECONDS: "10"
    ALLOWED_HOSTS: "*"
  envFromSecrets:
    - elevaite-secrets

ingestion:
  replicaCount: 1
  image:
    tag: "pr"
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 512Mi
  env:
    LOG_LEVEL: DEBUG
    ALLOWED_HOSTS: "*"
  envFromSecrets:
    - elevaite-secrets

worker:
  replicaCount: 1  # Single worker for PR envs
  image:
    tag: "pr"
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 512Mi
  env:
    LOG_LEVEL: DEBUG
  envFromSecrets:
    - elevaite-secrets
  autoscaling:
    enabled: false

# =============================================================================
# INGRESS (Dynamic hostname per PR)
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging
  api:
    host: api-pr.nip.io  # Set dynamically via --set ingress.api.host
    paths:
      - path: /api/auth
        pathType: Prefix
        service: auth-api
      - path: /
        pathType: Prefix
        service: workflow-engine
  authApp:
    enabled: true
    host: auth-pr.nip.io  # Set dynamically
  mainApp:
    enabled: true
    host: pr.nip.io  # Set dynamically
  tls: []

# =============================================================================
# FRONTEND APPS
# =============================================================================
frontend:
  auth:
    enabled: true
    replicaCount: 1
    image:
      tag: "pr"
      pullPolicy: Always
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi
    env: {}  # Set dynamically
  elevaite:
    enabled: true
    replicaCount: 1
    image:
      tag: "pr"
      pullPolicy: Always
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi
    env: {}  # Set dynamically

# =============================================================================
# EXTERNAL SERVICES (Shared Dev Infrastructure)
# PR environments use database-per-PR on shared managed PostgreSQL
# =============================================================================

# PostgreSQL - Shared dev managed instance, unique database per PR
postgresql:
  host: ""  # Shared dev database host from Terraform
  port: 5432
  database: "pr_${PR_NUMBER}"  # Set dynamically: CREATE DATABASE pr_123
  sslMode: "require"
  existingSecret: "elevaite-db-credentials"

# RabbitMQ - Internal instance per PR namespace
rabbitmq:
  internal:
    enabled: true
    replicaCount: 1
    auth:
      username: elevaite
      password: elevaite
      erlangCookie: elevaite-secret-cookie
    persistence:
      size: 1Gi
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 512Mi
  port: 5672
  vhost: "/"
  existingSecret: "elevaite-rabbitmq-credentials"

# Object Storage - Shared dev bucket with prefix per PR
objectStorage:
  provider: "aws"
  bucket: "elevaite-dev-files"
  region: "us-west-1"
  # Files are stored under prefix: pr-${PR_NUMBER}/
  existingSecret: "elevaite-storage-credentials"

# =============================================================================
# MIGRATIONS (Single tenant for PR envs)
# =============================================================================
migrations:
  enabled: true
  backoffLimit: 2  # Lower retry limit for faster failure feedback
  tenants:
    - default  # Only migrate default tenant for PRs

# =============================================================================
# SERVICE ACCOUNT
# =============================================================================
serviceAccount:
  create: true
  annotations: {}
