# Check if uv is available
if ! command -v uv &> /dev/null; then
  echo ""
  echo "âŒ ERROR: uv is not installed"
  echo ""
  echo "uv is required for development. Install it:"
  echo ""
  echo "  macOS:   brew install uv"
  echo "  Windows: winget install astral-sh.uv"
  echo "  Linux:   curl -LsSf https://astral.sh/uv/install.sh | sh"
  echo ""
  echo "Then run: uv sync"
  echo ""
  exit 1
fi

# Check if .venv exists, if not run uv sync with dev dependencies
if [ ! -d ".venv" ]; then
  echo "ğŸ“¦ .venv not found, running uv sync..."
  uv sync --group dev
fi

# Check if ruff is installed, if not install dev dependencies
if [ ! -f ".venv/bin/ruff" ]; then
  echo "ğŸ“¦ ruff not found, installing dev dependencies..."
  uv sync --group dev
fi

# Fix permissions on .venv/bin if needed (common issue on some systems)
if [ -d ".venv/bin" ] && [ ! -x ".venv/bin/ruff" ] 2>/dev/null; then
  echo "ğŸ”§ Fixing .venv permissions..."
  chmod -R +x .venv/bin/
fi

echo "ğŸ” Checking what changed..."

# Check if any Python files changed in ACTIVE apps only
PYTHON_CHANGED=$(git diff --name-only HEAD @{u} 2>/dev/null | grep -E '^(python_apps/(auth_api|workflow-engine-poc|ingestion-service)|python_packages)/.*\.py$' || true)

# Check if any frontend files changed in ACTIVE apps only
FRONTEND_CHANGED=$(git diff --name-only HEAD @{u} 2>/dev/null | grep -E '^apps/(auth|elevaite)/.*\.(ts|tsx|js|jsx)$' || true)

# Run Python lint only if Python files changed
if [ -n "$PYTHON_CHANGED" ]; then
  echo "ğŸ“¦ Python files changed, running Python lint..."
  npm run lint:python && npm run format:python:check
  if [ $? -ne 0 ]; then
    echo "âŒ Python lint failed. Fix errors before pushing."
    exit 1
  fi
  echo "âœ… Python lint passed"
else
  echo "â­ï¸  No Python files changed, skipping Python lint"
fi

# Run frontend lint only if frontend files changed
if [ -n "$FRONTEND_CHANGED" ]; then
  echo "ğŸ¨ Frontend files changed, running frontend lint..."
  npm run lint
  if [ $? -ne 0 ]; then
    echo "âŒ Frontend lint failed. Fix errors before pushing."
    exit 1
  fi
  echo "âœ… Frontend lint passed"
else
  echo "â­ï¸  No frontend files changed, skipping frontend lint"
fi

echo "âœ… All checks passed. Pushing..."
