name: Deploy to Testing (EKS)

on:
  push:
    branches: [ testing ]

permissions:
  contents: read

concurrency:
  group: testing-deploy-${{ github.sha }}
  cancel-in-progress: true

jobs:
  build-and-push-changed:
    name: Build & Push (changed components)
    runs-on: ubuntu-latest
    outputs:
      ui_tag: ${{ steps.out.tags_ui }}
      api_tag: ${{ steps.out.tags_api }}
      auth_tag: ${{ steps.out.tags_auth }}
      retriever_tags_json: ${{ steps.out.tags_retrievers }}
      retr_power_tag: ${{ steps.build_retrievers.outputs.retr_power_tag }}
      retr_sql_tag: ${{ steps.build_retrievers.outputs.retr_sql_tag }}
      retr_tgcs_tag: ${{ steps.build_retrievers.outputs.retr_tgcs_tag }}
      retr_topgun_tag: ${{ steps.build_retrievers.outputs.retr_topgun_tag }}
    env:
      ECR_REGISTRY: ${{ secrets.TGCS_ECR_REGISTRY }}
      TAG: testing-${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed paths (since previous commit)
        id: changes
        run: |
          set -euo pipefail
          if [[ -n "${{ github.event.before }}" && "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA="${{ github.event.before }}"
          else
            # Fallback: previous commit on this branch
            BASE_SHA="$(git rev-parse HEAD~1)"
          fi
          git diff --name-only "$BASE_SHA" HEAD > changed.txt
          echo "Changed files:"
          cat changed.txt || true

          has_ui=false
          has_api=false
          has_auth=false
          has_retrievers=false

          grep -q '^apps/toshiba/' changed.txt && has_ui=true || true
          grep -q '^python_apps/toshiba_backends/toshiba_backend/' changed.txt && has_api=true || true
          grep -q '^python_apps/auth_api/' changed.txt && has_auth=true || true
          # any retriever dir touched
          grep -q '^python_apps/toshiba_backends/.*retriever' changed.txt && has_retrievers=true || true

          echo "has_ui=$has_ui"   >> $GITHUB_OUTPUT
          echo "has_api=$has_api" >> $GITHUB_OUTPUT
          echo "has_auth=$has_auth" >> $GITHUB_OUTPUT
          echo "has_retrievers=$has_retrievers" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.STAGE_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.STAGE_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.STAGE_AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v1

      - name: Build UI (if changed)
        if: steps.changes.outputs.has_ui == 'true'
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-toshiba-ui"
          docker build \
            --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba \
            --build-arg NEXT_PUBLIC_AUTH_API_URL=https://tgcs-testing.iopex.ai/auth-api \
            --build-arg NEXT_PUBLIC_BACKEND_URL=https://tgcs-testing.iopex.ai/api/core/ \
            --build-arg NEXT_PUBLIC_MFA_METHODS_ENABLED=email \
            --build-arg NEXT_PUBLIC_MFA_ALLOW_DISABLE_ALL=false \
            -f apps/toshiba/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            .
          docker push "${IMAGE}:${TAG}"

      - name: Build API (if changed)
        if: steps.changes.outputs.has_api == 'true'
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-toshiba-backend"
          docker build \
            -f python_apps/toshiba_backends/toshiba_backend/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            python_apps/toshiba_backends/toshiba_backend
          docker push "${IMAGE}:${TAG}"

      - name: Build Auth (if changed)
        if: steps.changes.outputs.has_auth == 'true'
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-auth-api"
          docker build \
            -f python_apps/auth_api/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            .
          docker push "${IMAGE}:${TAG}"

      - name: Build retrievers (if changed)
        if: steps.changes.outputs.has_retrievers == 'true'
        id: build_retrievers
        run: |
          set -euo pipefail
          json="{"
          shopt -s nullglob

          for dir in python_apps/toshiba_backends/*retriever*; do
            [[ -f "$dir/Dockerfile" ]] || continue
            base="$(basename "$dir")"

            case "$base" in
              top_gun_retriever)  repo="elevaite-toshiba-topgun-retriever" ;;
              *)  repo="elevaite-toshiba-${base//_/-}" ;;
            esac

            IMAGE="${ECR_REGISTRY}/${repo}"
            echo ">> Building ${IMAGE}:${TAG} from ${dir}"
            docker build -f "${dir}/Dockerfile" -t "${IMAGE}:${TAG}" "${dir}"
            docker push "${IMAGE}:${TAG}"

            json="${json}\"${repo}\":\"${TAG}\","

            case "$base" in
              power_retriever)   echo "retr_power_tag=${TAG}"   >> "$GITHUB_OUTPUT" ;;
              sql_retriever)     echo "retr_sql_tag=${TAG}"     >> "$GITHUB_OUTPUT" ;;
              tgcs_retriever)    echo "retr_tgcs_tag=${TAG}"    >> "$GITHUB_OUTPUT" ;;
              top_gun_retriever) echo "retr_topgun_tag=${TAG}"  >> "$GITHUB_OUTPUT" ;;
            esac
          done

          json="${json%,}}"
          echo "retriever_tags_json=${json}" >> "$GITHUB_OUTPUT"

      - name: Export tags
        id: out
        run: |
          # Only set outputs for components we built; others remain empty so helm keeps current tag
          if [[ "${{ steps.changes.outputs.has_ui }}" == "true" ]]; then
            echo "tags_ui=${TAG}" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ steps.changes.outputs.has_api }}" == "true" ]]; then
            echo "tags_api=${TAG}" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ steps.changes.outputs.has_auth }}" == "true" ]]; then
            echo "tags_auth=${TAG}" >> $GITHUB_OUTPUT
          fi
          # forward retrievers (may be empty)
          echo "tags_retrievers=${{ steps.build_retrievers.outputs.retriever_tags_json }}" >> $GITHUB_OUTPUT

  deploy:
    if: |
      needs.build-and-push-changed.outputs.ui_tag != '' ||
      needs.build-and-push-changed.outputs.api_tag != '' ||
      needs.build-and-push-changed.outputs.auth_tag != '' ||
      needs.build-and-push-changed.outputs.retriever_tags_json != ''    
    needs: build-and-push-changed
    uses: iopexses/elev8s/.github/workflows/reusable-dep-to-env.yml@main
    with:
        environment: testing
        toshiba_ui_tag: ${{ needs.build-and-push-changed.outputs.ui_tag }}
        toshiba_api_tag: ${{ needs.build-and-push-changed.outputs.api_tag }}
        toshiba_auth_tag: ${{ needs.build-and-push-changed.outputs.auth_tag }}
        # retriever_tags_json: ${{ needs.build-and-push-changed.outputs.retriever_tags_json }}
        retr_power_tag: ${{ needs.build-and-push-all.outputs.retr_power_tag }}
        retr_sql_tag: ${{ needs.build-and-push-all.outputs.retr_sql_tag }}
        retr_tgcs_tag: ${{ needs.build-and-push-all.outputs.retr_tgcs_tag }}
        retr_topgun_tag: ${{ needs.build-and-push-all.outputs.retr_topgun_tag }}
    secrets:
        STAGE_AWS_ACCESS_KEY_ID: ${{ secrets.STAGE_AWS_ACCESS_KEY_ID }}
        STAGE_AWS_SECRET_ACCESS_KEY: ${{ secrets.STAGE_AWS_SECRET_ACCESS_KEY }}
        STAGE_AWS_REGION: ${{ secrets.STAGE_AWS_REGION }}
        STAGE_EKS_CLUSTER_NAME: ${{ secrets.STAGE_EKS_CLUSTER_NAME }}
        ELEV8S_READ_TOKEN: ${{ secrets.ELEV8S_READ_TOKEN }}