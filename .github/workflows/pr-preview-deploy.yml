name: PR Preview - Build, Push, Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - testing

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-changes:
    runs-on: self-hosted
    outputs:
      toshiba_ui_changed: ${{ steps.filter.outputs.ui }}
      toshiba_backend_changed: ${{ steps.filter.outputs.backend }}
      toshiba_analytics_backend_changed: ${{ steps.filter.outputs.analytics_backend }}
      toshiba_data_schema_changed: ${{ steps.filter.outputs.toshiba_data_schema }}
      toshiba_auth_changed: ${{ steps.filter.outputs.auth }}
      should_deploy: ${{ steps.set.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v4

      - name: Paths Filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            ui:
              - 'apps/toshiba/**'
            backend:
              - 'python_apps/toshiba_backends/toshiba_backend/**'
            analytics_backend:
              - 'python_apps/toshiba_backends/analytics_backend/**'
            toshiba_data_schema:
              - 'python_apps/toshiba_backends/toshiba_data_schema/**'
            auth:
              - 'python_apps/auth_api/**'

      - name: Decide deploy
        id: set
        run: |
          if [[ "${{ steps.filter.outputs.ui }}" == "true" || \
            "${{ steps.filter.outputs.backend }}" == "true" || \
            "${{ steps.filter.outputs.analytics_backend }}" == "true" || \
            "${{ steps.filter.outputs.toshiba_data_schema }}" == "true" || \
            "${{ steps.filter.outputs.auth }}" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    if: needs.check-changes.outputs.should_deploy == 'true'
    needs: check-changes
    runs-on: self-hosted
    outputs:
      toshiba_ui_tag: ${{ steps.set_tags.outputs.ui_tag }}
      toshiba_backend_tag: ${{ steps.set_tags.outputs.backend_tag }}
      toshiba_analytics_backend_tag: ${{ steps.set_tags.outputs.analytics_backend_tag }}
      toshiba_data_schema_tag: ${{ steps.set_tags.outputs.toshiba_data_schema_tag }}
      toshiba_auth_tag: ${{ steps.set_tags.outputs.auth_tag }}
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate with ECR
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Compute image tag and preview host
        id: meta
        run: |
          echo "branch_tag=pr-${{ github.event.pull_request.number }}-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "preview_host=pr-${PR_NUMBER}.dev.iopex.ai" >> $GITHUB_OUTPUT

      - name: Build and Push UI
        if: needs.check-changes.outputs.toshiba_ui_changed == 'true'
        run: |
          IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-ui"
          docker build \
          --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba \
          --build-arg NEXT_PUBLIC_AUTH_API_URL=https://${{ steps.meta.outputs.preview_host }}/auth-api \
          --build-arg NEXT_PUBLIC_BACKEND_URL=https://${{ steps.meta.outputs.preview_host }}/api/core/ \
          --build-arg NEXT_PUBLIC_API_URL=https://${{ steps.meta.outputs.preview_host }} \
          --build-arg NEXT_PUBLIC_MFA_METHODS_ENABLED=email \
          --build-arg NEXT_PUBLIC_MFA_ALLOW_DISABLE_ALL=false \
          -f apps/toshiba/Dockerfile \
          -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
          .

          docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}

      - name: Build and Push Backend
        if: needs.check-changes.outputs.toshiba_backend_changed == 'true'
        run: |
          IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-backend"
          docker build \
          -f python_apps/toshiba_backends/toshiba_backend/Dockerfile \
          -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
          python_apps/toshiba_backends/toshiba_backend

          docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}

      - name: Build and Push Analytics Backend
        if: needs.check-changes.outputs.toshiba_analytics_backend_changed == 'true'
        run: |
          IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-analytics-backend"
          docker build \
          -f python_apps/toshiba_backends/analytics_backend/Dockerfile \
          -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
          python_apps/toshiba_backends/analytics_backend

          docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}

      # Note: this is not a running service, just a container to hold the code and push to ECR
      - name: Build and Push Toshiba Data Schema
        if: needs.check-changes.outputs.toshiba_data_schema_changed == 'true'
        run: |
          IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-data-schema"
          docker build \
          -f python_apps/toshiba_backends/toshiba_data_schema/Dockerfile \
          -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
          python_apps/toshiba_backends/toshiba_data_schema

          docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}

      - name: Build and Push Auth
        if: needs.check-changes.outputs.toshiba_auth_changed == 'true'
        run: |
          IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-auth-api"
          docker build \
          -f python_apps/auth_api/Dockerfile \
          -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
          .

          docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}

      - name: Set Tags
        id: set_tags
        run: |
          if [[ "${{ needs.check-changes.outputs.toshiba_ui_changed }}" == "true" ]]; then
            echo "ui_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${{ needs.check-changes.outputs.toshiba_backend_changed }}" == "true" ]]; then
            echo "backend_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${{ needs.check-changes.outputs.toshiba_analytics_backend_changed }}" == "true" ]]; then
            echo "analytics_backend_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${{ needs.check-changes.outputs.toshiba_data_schema_changed }}" == "true" ]]; then
            echo "toshiba_data_schema_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${{ needs.check-changes.outputs.toshiba_auth_changed }}" == "true" ]]; then
            echo "auth_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
          fi

  deploy-preview:
    if: needs.check-changes.outputs.should_deploy == 'true'
    needs: [build-and-push, check-changes]
    uses: iopexses/elev8s/.github/workflows/reusable-deploy-preview.yml@main
    with:
      pr_number: ${{ github.event.pull_request.number }}
      chart_path: ./elev8s/helm
      host_domain: dev.iopex.ai
      tls_secret_name: wildcard-cert-latest
      tls_secret_namespace: default
      toshiba_ui_tag: ${{ needs.build-and-push.outputs.toshiba_ui_tag }}
      toshiba_api_tag: ${{ needs.build-and-push.outputs.toshiba_backend_tag }}
      toshiba_analytics_api_tag: ${{ needs.build-and-push.outputs.toshiba_analytics_backend_tag }}
      toshiba_auth_tag: ${{ needs.build-and-push.outputs.toshiba_auth_tag }}
    secrets:
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      ELEV8S_READ_TOKEN: ${{ secrets.ELEV8S_READ_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-2

  comment-pr:
    if: needs.check-changes.outputs.should_deploy == 'true'
    needs: [deploy-preview, check-changes]
    runs-on: self-hosted
    steps:
      - name: Comment on PR with preview + logs links
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GRAFANA_HOST: https://grafana.dev.iopex.ai
          GRAFANA_DASH_UID: elevaite-pr-logs
          ORG_ID: "1"
        run: |
          set -euo pipefail

          PR=${{ github.event.pull_request.number }}
          PREVIEW_URL="https://pr-${PR}.dev.iopex.ai"
          NS="elevaite-pr-${PR}"

          GRAFANA_HOST="https://grafana.dev.iopex.ai"
          ORG_ID="1"
          DASH_SLUG="elevaite-pr-logs"

          LOGS_URL="${GRAFANA_HOST}/d/${GRAFANA_DASH_UID}/${DASH_SLUG}?orgId=${ORG_ID}&var-namespace=${NS}&from=now-15m&to=now"

          MSG=$(cat <<EOF
          âœ… Preview deployed:
          - App: **${PREVIEW_URL}**
          - Logs (namespace filtered): **${LOGS_URL}**

          _Tip: Cmd/Ctrl click to open in a new tab. Time range = last 1h; adjust in Grafana as needed._

          EOF
          )

          echo "$MSG"
          gh pr comment "$PR" --body "$MSG"