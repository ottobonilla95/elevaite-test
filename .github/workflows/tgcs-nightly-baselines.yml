# This pipeline provides pre-built images for some application components in order to speed up PR builds.
# That way PR builds only need to build the components that have changed within the PR.
# Images are tagged "latest-baseline", and "baseline-{run-id}"
#
# IMPORTANT:
#  Only the version of this workflow on the 'develop' branch takes any effect because scheduled workflows always
#  run from the primary branch.
#  Thus, unlike all the other TGCS workflows, this one needs to be kept correct and up-to-date on the develop branch.

name: TGCS - Nightly Baselines
on:
  schedule:
    - cron: "15 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-baselines:
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: ${{ secrets.TGCS_ECR_REGISTRY }}
      RUN_TAG: baseline-${{ github.run_id }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Don't build UI component because it needs extra env-specific parameters and must always be built for each deployment.

          # backend services
          - name: api
            kind: svc
            dockerfile: python_apps/toshiba_backends/toshiba_backend/Dockerfile
            image: elevaite-toshiba-backend
            context: python_apps/toshiba_backends/toshiba_backend
          - name: analytics-api
            kind: svc
            dockerfile: python_apps/toshiba_backends/analytics_backend/Dockerfile
            image: elevaite-toshiba-analytics-backend
            context: python_apps/toshiba_backends/analytics_backend
          - name: toshiba_data_schema
            kind: svc
            dockerfile: python_apps/toshiba_backends/toshiba_data_schema/Dockerfile
            image: elevaite-toshiba-data-schema
            context: python_apps/toshiba_backends/toshiba_data_schema
          - name: auth
            kind: svc
            dockerfile: python_apps/auth_api/Dockerfile
            image: elevaite-auth-api
            context: .
          - name: sql-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/sql_retriever/Dockerfile
            image: elevaite-toshiba-sql-retriever
            context: python_apps/toshiba_backends/sql_retriever
          - name: tgcs-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/tgcs_retriever/Dockerfile
            image: elevaite-toshiba-tgcs-retriever
            context: python_apps/toshiba_backends/tgcs_retriever
          - name: topgun-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/top_gun_retriever/Dockerfile
            image: elevaite-toshiba-topgun-retriever
            context: python_apps/toshiba_backends/top_gun_retriever
          - name: power-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/power_retriever/Dockerfile
            image: elevaite-toshiba-power-retriever
            context: python_apps/toshiba_backends/power_retriever
          - name: video-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/video_retriever/Dockerfile
            image: elevaite-toshiba-video-retriever
            context: python_apps/toshiba_backends/video_retriever

    steps:
      # note: must run against the main branch, because the 'release' branch can be behind and either
      # not have newly added components present or be missing important changes needed in PR builds.
      - uses: actions/checkout@v4
        with:
          ref: tgcs-main

      - uses: docker/setup-buildx-action@v3

      - uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.STAGE_AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v1

      - name: Build & push ${{ matrix.name }}
        run: |
          set -euo pipefail
          IMAGE="${ECR_REGISTRY}/${{ matrix.image }}"

          if [[ "${{ matrix.kind }}" == "svc" ]]; then
            docker build \
                -f "${{ matrix.dockerfile }}" \
                -t "${IMAGE}:latest-baseline" \
                -t "${IMAGE}:${RUN_TAG}" \
                "${{ matrix.context }}"

            docker push "${IMAGE}:latest-baseline"
            docker push "${IMAGE}:${RUN_TAG}"
          else
            echo "::error title=Bad pipeline configuration::No build logic for ${{ matrix.kind }} kind"; exit 1;
          fi
