name: Deploy to Production (EKS)

on:
  # Don't auto-deploy on merge to develop because main Elevaite does a lot of pushes there
  # push:
  #   branches: [ develop, main ]

  # Manual trigger only, but always from   
  workflow_dispatch:
    inputs:
      source_ref:
        description: "Git ref to build from (branch, tag, or SHA)"
        required: false
        default: "develop"

permissions:
  contents: read

concurrency:
  # using run ID because can be run multiple times against same git commit
  group: prod-deploy-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  build-and-push-all:
    name: Build & Push ALL images
    runs-on: ubuntu-latest
    outputs:
      ui_tag:            ${{ steps.main_tags.outputs.ui_tag }}
      api_tag:           ${{ steps.main_tags.outputs.api_tag }}
      analytics_api_tag: ${{ steps.main_tags.outputs.analytics_api_tag }}
      auth_tag:          ${{ steps.main_tags.outputs.auth_tag }}
      retr_power_tag:    ${{ steps.build_retrievers.outputs.retr_power_tag }}
      retr_sql_tag:      ${{ steps.build_retrievers.outputs.retr_sql_tag }}
      retr_tgcs_tag:     ${{ steps.build_retrievers.outputs.retr_tgcs_tag }}
      retr_topgun_tag:   ${{ steps.build_retrievers.outputs.retr_topgun_tag }}
      retr_video_tag:    ${{ steps.build_retrievers.outputs.retr_video_tag }}
    env:
      ECR_REGISTRY: ${{ secrets.TGCS_ECR_REGISTRY }}
      # using run ID because can be run multiple times against same git commit
      TAG: prod-${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_ref }}

      - uses: docker/setup-buildx-action@v3

      - uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.PROD_AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v1

      - name: Build UI
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-toshiba-ui"
          docker build \
            --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba \
            --build-arg NEXT_PUBLIC_AUTH_API_URL=https://tgcs.iopex.ai/auth-api \
            --build-arg NEXT_PUBLIC_BACKEND_URL=https://tgcs.iopex.ai/api/core/ \
            --build-arg NEXT_PUBLIC_API_URL=https://tgcs.iopex.ai \
            --build-arg NEXT_PUBLIC_MFA_METHODS_ENABLED="email,biometric" \
            --build-arg NEXT_PUBLIC_MFA_ALLOW_DISABLE_ALL=false \
            -f apps/toshiba/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            .
          docker push "${IMAGE}:${TAG}"

      - name: Build API
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-toshiba-backend"
          docker build \
            -f python_apps/toshiba_backends/toshiba_backend/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            python_apps/toshiba_backends/toshiba_backend
          docker push "${IMAGE}:${TAG}"

      - name: Build Analytics API
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-toshiba-analytics-backend"
          docker build \
            -f python_apps/toshiba_backends/analytics_backend/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            python_apps/toshiba_backends/analytics_backend
          docker push "${IMAGE}:${TAG}"

      # Note: this is not a running service, just a container to hold the code and push to ECR
      - name: Build Toshiba Data Schema image
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-toshiba-data-schema"
          docker build \
            -f python_apps/toshiba_backends/toshiba_data_schema/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            python_apps/toshiba_backends/toshiba_data_schema
          docker push "${IMAGE}:${TAG}"

      - name: Build Auth
        run: |
          IMAGE="${ECR_REGISTRY}/elevaite-auth-api"
          docker build \
            -f python_apps/auth_api/Dockerfile \
            -t "${IMAGE}:${TAG}" \
            .
          docker push "${IMAGE}:${TAG}"

      - name: Build ALL retrievers
        id: build_retrievers
        run: |
          set -euo pipefail
          shopt -s nullglob
          for dir in python_apps/toshiba_backends/*retriever*; do
            [[ -f "$dir/Dockerfile" ]] || continue
            base="$(basename "$dir")"
            case "$base" in
              top_gun_retriever) repo="elevaite-toshiba-topgun-retriever" ;;
              *)                 repo="elevaite-toshiba-${base//_/-}" ;;
            esac

            IMAGE="${ECR_REGISTRY}/${repo}"
            echo ">> Building ${IMAGE}:${TAG} from ${dir}"
            docker build -f "${dir}/Dockerfile" -t "${IMAGE}:${TAG}" "${dir}"
            docker push "${IMAGE}:${TAG}"

            case "$base" in
              power_retriever)   echo "retr_power_tag=${TAG}"   >> "$GITHUB_OUTPUT" ;;
              sql_retriever)     echo "retr_sql_tag=${TAG}"     >> "$GITHUB_OUTPUT" ;;
              tgcs_retriever)    echo "retr_tgcs_tag=${TAG}"    >> "$GITHUB_OUTPUT" ;;
              top_gun_retriever) echo "retr_topgun_tag=${TAG}"  >> "$GITHUB_OUTPUT" ;;
              video_retriever)   echo "retr_video_tag=${TAG}"   >> "$GITHUB_OUTPUT" ;;
            esac
          done

      - name: Export main tags
        id: main_tags
        run: |
          echo "ui_tag=${TAG}"            >> "$GITHUB_OUTPUT"
          echo "api_tag=${TAG}"           >> "$GITHUB_OUTPUT"
          echo "analytics_api_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "auth_tag=${TAG}"          >> "$GITHUB_OUTPUT"

  deploy:
    needs: build-and-push-all
    uses: iopexses/elev8s/.github/workflows/reusable-dep-to-env.yml@main
    with:
      environment: prod
      toshiba_ui_tag:            ${{ needs.build-and-push-all.outputs.ui_tag }}
      toshiba_api_tag:           ${{ needs.build-and-push-all.outputs.api_tag }}
      toshiba_analytics_api_tag: ${{ needs.build-and-push-all.outputs.analytics_api_tag }}
      toshiba_auth_tag:          ${{ needs.build-and-push-all.outputs.auth_tag }}
      # FIXME retriever tags are currently ignored by elev8s code and always deploys 'latest' tag
      retr_power_tag:            ${{ needs.build-and-push-all.outputs.retr_power_tag }}
      retr_sql_tag:              ${{ needs.build-and-push-all.outputs.retr_sql_tag }}
      retr_tgcs_tag:             ${{ needs.build-and-push-all.outputs.retr_tgcs_tag }}
      retr_topgun_tag:           ${{ needs.build-and-push-all.outputs.retr_topgun_tag }}
      retr_video_tag:            ${{ needs.build-and-push-all.outputs.retr_video_tag }}
    secrets:
      PROD_AWS_ACCESS_KEY_ID:      ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
      PROD_AWS_SECRET_ACCESS_KEY:  ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
      PROD_AWS_REGION:             ${{ secrets.PROD_AWS_REGION }}
      PROD_EKS_CLUSTER_NAME:       ${{ secrets.PROD_EKS_CLUSTER_NAME }}
      STAGE_AWS_ACCESS_KEY_ID:     ${{ secrets.STAGE_AWS_ACCESS_KEY_ID }}
      STAGE_AWS_SECRET_ACCESS_KEY: ${{ secrets.STAGE_AWS_SECRET_ACCESS_KEY }}
      STAGE_AWS_REGION:            ${{ secrets.STAGE_AWS_REGION }}
      ELEV8S_READ_TOKEN:           ${{ secrets.ELEV8S_READ_TOKEN }}
