name: TGCS - Cleanup PR Preview

on:
  # Automatic undeploy on pull-request close
  # Or, optional ability to re-run for specified PR in case of failed cleanup
  pull_request:
    types: [ closed ]
    branches: [ tgcs-main, tgcs-release ]
  workflow_dispatch:
    input:
      pull_request_number:
        description: "Pull request number to cleanup for"
        required: true

jobs:
  cleanup-preview:
    uses: iopexses/elev8s/.github/workflows/reusable-cleanup-preview.yml@main
    with:
      pr_number: ${{ github.event.pull_request.number || inputs.pull_request_number }}
    secrets:
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

  deactivate-deployment:
    needs: cleanup-preview
    runs-on: ubuntu-latest
    permissions:
      deployments: write
    env:
      ENV_NAME: PR-${{ github.event.pull_request.number }}-testing
    steps:
      - name: Deactivate latest deployments for this PR env
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const envName = process.env.ENV_NAME;

            const { data: deployments } = await github.request(
              'GET /repos/{owner}/{repo}/deployments',
              {owner, repo, environment: envName, per_page: 1 }
            );

            if (!deployments.length) {
              core.info(`No deployment found for environment ${envName}`);
              return;
            }

            const deployment_id = deployments[0].id;

            await github.request(
              'POST /repos/{owner}/{repo}/deployments/{deployment_id}/statuses',
              {
                owner, repo, deployment_id,
                state: 'inactive',
                description: 'Preview cleaned up; environment deactivated'
              }
            );

            core.info(`Deployment ${deployment_id} marked as inactive for ${envName}.`);
