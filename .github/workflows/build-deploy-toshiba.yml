name: Build and Deploy Toshiba App

on:
  push:
    branches:
      - '**'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      toshiba_ui_changed: ${{ steps.check.outputs.toshiba_ui_changed }}
      toshiba_backend_changed: ${{ steps.check.outputs.toshiba_backend_changed }}
      toshiba_auth_changed: ${{ steps.check.outputs.toshiba_auth_changed }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch develop branch
        run: |
          git fetch origin develop --depth=20

      - name: Detect Changes
        id: check
        run: |
          if git merge-base --is-ancestor origin/develop HEAD; then
            echo "Using three-dot diff against develop branch..."
            git diff --name-only origin/develop...HEAD > changed_files.txt            
          else
            echo "No common ancestor found. Using full HEAD diff."
            git diff --name-only HEAD > changed_files.txt
          fi
          
          echo "Changed Files:"
          cat changed_files.txt

          UI_CHANGED=false
          BACKEND_CHANGED=false
          AUTH_CHANGED=false

          if grep -q '^apps/toshiba/' changed_files.txt; then
            UI_CHANGED=true
          fi
          if grep -q '^elevaite_backend/toshiba_backend/' changed_files.txt; then
            BACKEND_CHANGED=true
          fi
          if grep -q '^python_apps/auth_api/' changed_files.txt; then
            AUTH_CHANGED=true
          fi

          echo "toshiba_ui_changed=${UI_CHANGED}" >> $GITHUB_OUTPUT
          echo "toshiba_backend_changed=${BACKEND_CHANGED}" >> $GITHUB_OUTPUT
          echo "toshiba_auth_changed=${AUTH_CHANGED}" >> $GITHUB_OUTPUT

          SHOULD_DEPLOY=$([[ "${UI_CHANGED}" == "true" || "${BACKEND_CHANGED}" == "true" || "${AUTH_CHANGED}" == "true" ]] && echo "true" || echo "false")
          echo "should_deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT

  build-and-push:
    if: needs.check-changes.outputs.should_deploy == 'true'
    needs: check-changes
    runs-on: ubuntu-latest
    outputs:
      toshiba_ui_tag: ${{ steps.set_tags.outputs.ui_tag }}
      toshiba_backend_tag: ${{ steps.set_tags.outputs.backend_tag }}
      toshiba_auth_tag: ${{ steps.set_tags.outputs.auth_tag }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
    
      - name: Authenticate with AWS
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Set Branch
        id: meta
        run: |
          echo "branch_tag=$(echo ${{ github.ref_name }} | tr '/' '-')" >> $GITHUB_OUTPUT

      - name: Build & Push Toshiba UI
        if: needs.check-changes.outputs.toshiba_ui_changed == 'true'
        run: |
            IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-ui"
            docker build \
                --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba \
                --build-arg NEXT_PUBLIC_AUTH_API_URL=https://tgcs-staging.iopex.ai \
                --build-arg NEXT_PUBLIC_BACKEND_URL=https://tgcs-staging.iopex.ai/api/core/ \
                -f apps/toshiba/Dockerfile \
                -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
                -t ${IMAGE}:latest \
                .

            docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}
            docker push ${IMAGE}:latest

      - name: Build & Push Toshiba Backend
        if: needs.check-changes.outputs.toshiba_backend_changed == 'true'
        run: |
            IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-backend"
            docker build \
              -f elevaite_backend/toshiba_backend/Dockerfile \
              -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
              -t ${IMAGE}:latest \
              elevaite_backend/toshiba_backend

            docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}
            docker push ${IMAGE}:latest

      - name: Build & Push Toshiba Auth API
        if: needs.check-changes.outputs.toshiba_auth_changed == 'true'
        run: |
            IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-auth-api"
            docker build \
              -f python_apps/auth_api/Dockerfile \
              -t ${IMAGE}:${{ steps.meta.outputs.branch_tag }} \
              -t ${IMAGE}:latest \
              .

            docker push ${IMAGE}:${{ steps.meta.outputs.branch_tag }}
            docker push ${IMAGE}:latest

      - name: Set image tags as outputs
        id: set_tags
        run: |
            if [[ "$TOSHIBA_UI_CHANGED" == "true" ]]; then
                echo "ui_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
            fi
            if [[ "$TOSHIBA_BACKEND_CHANGED" == "true" ]]; then
                echo "backend_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
            fi
            if [[ "$TOSHIBA_AUTH_CHANGED" == "true" ]]; then
                echo "auth_tag=${{ steps.meta.outputs.branch_tag }}" >> "$GITHUB_OUTPUT"
            fi
        env:
          TOSHIBA_UI_CHANGED: ${{ needs.check-changes.outputs.toshiba_ui_changed }}
          TOSHIBA_BACKEND_CHANGED: ${{ needs.check-changes.outputs.toshiba_backend_changed }}
          TOSHIBA_AUTH_CHANGED: ${{ needs.check-changes.outputs.toshiba_auth_changed }}

  deploy-toshiba:
    if: needs.check-changes.outputs.should_deploy == 'true'
    name: Deploy Toshiba
    needs: [build-and-push, check-changes]
    uses: iopexses/elev8s/.github/workflows/deploy-stage.yaml@reusable-action
    with:
      environment: staging
      toshiba_ui_tag: ${{ needs.build-and-push.outputs.toshiba_ui_tag || 'latest'}}
      toshiba_api_tag: ${{ needs.build-and-push.outputs.toshiba_backend_tag || 'latest'}}
      toshiba_auth_tag: ${{ needs.build-and-push.outputs.toshiba_auth_tag || 'latest'}}
    secrets:
      STAGE_AWS_ACCESS_KEY_ID: ${{ secrets.STAGE_AWS_ACCESS_KEY_ID }}
      STAGE_AWS_SECRET_ACCESS_KEY: ${{ secrets.STAGE_AWS_SECRET_ACCESS_KEY }}
      STAGE_AWS_REGION: ${{ secrets.STAGE_AWS_REGION }}
      STAGE_EKS_CLUSTER_NAME: ${{ secrets.STAGE_EKS_CLUSTER_NAME }}
      ELEV8S_READ_TOKEN: ${{ secrets.ELEV8S_READ_TOKEN }}

  comment-pr:
    if: needs.check-changes.outputs.should_deploy == 'true' && github.event_name == 'push'
    needs: [deploy-toshiba, check-changes]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR Number
        id: get_pr_number
        uses: jwalton/gh-find-current-pr@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit log and changed files
        id: changes
        run: |
          git fetch origin develop --depth=20 || true

          echo "commit_log<<EOF" >> $GITHUB_OUTPUT
          git log origin/develop..HEAD --oneline >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "files_changed<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/develop..HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up GitHub CLI
        run: |
          sudo apt-get install gh -y

      - name: Comment on PR
        if: success() && steps.get_pr_number.outputs.number
        run: |
          gh pr comment ${{ steps.get_pr_number.outputs.number }} --body "
          ‚úÖ **Deployment to Staging Complete**

          üîÅ **Changes Deployed**:
          \`\`\`
          ${{ steps.changes.outputs.files_changed }}
          \`\`\`

          üìå **Commits**:
          \`\`\`
          ${{ steps.changes.outputs.commit_log }}
          \`\`\`

          üåê [Test the changes here](https://tgcs-staging.iopex.ai)
          "

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
