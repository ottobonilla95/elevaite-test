name: Build Toshiba App

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build-toshiba:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' || 
      github.event_name == 'pull_request'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: ${{ runner.os }}-buildx-

      - name: Fetch full history
        run: git fetch --no-tags --prune --depth=2 origin develop

      - name: Set short SHA
        id: meta
        run: echo "sha_short=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Check Toshiba UI changes
        id: check_ui
        run: |
            if git diff --name-only origin/develop | grep -q '^apps/toshiba/'; then
                echo "toshiba_ui_changed=true" >> $GITHUB_OUTPUT
            else
                echo "toshiba_ui_changed=false" >> $GITHUB_OUTPUT
            fi

      - name: Check Toshiba Backend changes
        id: check_backend
        run: |
            if git diff --name-only origin/develop | grep -q '^elevaite_backend/toshiba_backend/'; then
                echo "toshiba_backend_changed=true" >> $GITHUB_OUTPUT
            else
                echo "toshiba_backend_changed=false" >> $GITHUB_OUTPUT
            fi

      - name: Check Toshiba Auth API changes
        id: check_auth
        run: |
            if git diff --name-only origin/develop | grep -q '^python_apps/auth_api/'; then
                echo "toshiba_auth_changed=true" >> $GITHUB_OUTPUT
            else
                echo "toshiba_auth_changed=false" >> $GITHUB_OUTPUT
            fi

      - name: Authenticate with AWS
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build & Push Toshiba UI
        if: steps.check_ui.outputs.toshiba_ui_changed == 'true'
        run: |
            IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-ui"
            TAG=staging-${{ steps.meta.outputs.sha_short }}
            docker build \
                --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba \
                --build-arg NEXT_PUBLIC_AUTH_API_URL=https://elevaite-staging.iopex.ai \
                --build-arg NEXT_PUBLIC_BACKEND_URL=https://elevaite-staging.iopex.ai/api/core/ \
                -f apps/toshiba/Dockerfile \
                -t ${IMAGE}:${TAG} \
                .

            docker push ${IMAGE}:${TAG}

      - name: Build & Push Toshiba Backend
        if: steps.check_backend.outputs.toshiba_backend_changed == 'true'
        run: |
            IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-toshiba-backend"
            TAG=staging-${{ steps.meta.outputs.sha_short }}
            docker build \
              -f elevaite_backend/toshiba_backend/Dockerfile \
              -t ${IMAGE}:${TAG} \
              elevaite_backend/toshiba_backend

            docker push ${IMAGE}:${TAG}

      - name: Build & Push Toshiba Auth API
        if: steps.check_auth.outputs.toshiba_auth_changed == 'true'
        run: |
            IMAGE="${{ secrets.TGCS_ECR_REGISTRY }}/elevaite-auth-api"
            TAG=staging-${{ steps.meta.outputs.sha_short }}
            docker build \
              -f python_apps/auth_api/Dockerfile \
              -t ${IMAGE}:${TAG} \
              .

            docker push ${IMAGE}:${TAG}


      - name: CI Summary
        run: |
            echo "Toshiba changed: ${{ steps.check_ui.outputs.toshiba_ui_changed }}"
            echo "Toshiba Backend changed: ${{ steps.check_backend.outputs.toshiba_backend_changed }}"
            echo "Toshiba Auth API changed: ${{ steps.check_auth.outputs.toshiba_auth_changed }}"