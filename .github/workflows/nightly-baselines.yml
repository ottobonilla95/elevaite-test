# This pipeline provides pre-built images for all application components in order to speed up PR builds.
# PR builds only need to build the components that have changed within the PR.
#
# TODO confirm that only the 'testing' env_name instances are used and avoid building the rest.
# Note: the retrievers might also be used by main Elevaite.
# Need to check for usages of the 'latest' tags in Elevaite deployments.

name: Nightly Baselines
on:
  schedule:
    - cron: "15 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-baselines:
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: ${{ secrets.TGCS_ECR_REGISTRY }}
      DATE_TAG: baseline-${{ github.run_id }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ui-testing
            kind: ui
            env_name: testing
            base_url: ${{ vars.TESTING_BASE_URL }}
            dockerfile: apps/toshiba/Dockerfile
            image: elevaite-toshiba-ui
            context: .
          - name: ui-staging
            kind: ui
            env_name: staging
            base_url: ${{ vars.STAGING_BASE_URL }}
            dockerfile: apps/toshiba/Dockerfile
            image: elevaite-toshiba-ui
            context: .
          - name: ui-production
            kind: ui
            env_name: production
            base_url: ${{ vars.PRODUCTION_BASE_URL }}
            dockerfile: apps/toshiba/Dockerfile
            image: elevaite-toshiba-ui
            context: .

          - name: api
            kind: svc
            dockerfile: python_apps/toshiba_backends/toshiba_backend/Dockerfile
            image: elevaite-toshiba-backend
            context: python_apps/toshiba_backends/toshiba_backend
          - name: analytics-api
            kind: svc
            dockerfile: python_apps/toshiba_backends/analytics_backend/Dockerfile
            image: elevaite-toshiba-analytics-backend
            context: python_apps/toshiba_backends/analytics_backend
          - name: toshiba_data_schema
            kind: svc
            dockerfile: python_apps/toshiba_backends/toshiba_data_schema/Dockerfile
            image: elevaite-toshiba-data-schema
            context: python_apps/toshiba_backends/toshiba_data_schema
          - name: auth
            kind: svc
            dockerfile: python_apps/auth_api/Dockerfile
            image: elevaite-auth-api
            context: .
          - name: sql-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/sql_retriever/Dockerfile
            image: elevaite-toshiba-sql-retriever
            context: python_apps/toshiba_backends/sql_retriever
          - name: tgcs-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/tgcs_retriever/Dockerfile
            image: elevaite-toshiba-tgcs-retriever
            context: python_apps/toshiba_backends/tgcs_retriever
          - name: topgun-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/top_gun_retriever/Dockerfile
            image: elevaite-toshiba-topgun-retriever
            context: python_apps/toshiba_backends/top_gun_retriever
          - name: power-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/power_retriever/Dockerfile
            image: elevaite-toshiba-power-retriever
            context: python_apps/toshiba_backends/power_retriever
          - name: video-retriever
            kind: svc
            dockerfile: python_apps/toshiba_backends/video_retriever/Dockerfile
            image: elevaite-toshiba-video-retriever
            context: python_apps/toshiba_backends/video_retriever

    steps:
      # note: must run against the testing branch, because the 'develop' branch (default) can be behind
      # and either not have newly added components present or be missing important changes needed in PR builds.
      - uses: actions/checkout@v4
        with:
          ref: testing

      - uses: docker/setup-buildx-action@v3

      - uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.STAGE_AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v1

      - name: Build & push ${{ matrix.name }}
        run: |
          set -euo pipefail
          IMAGE="${ECR_REGISTRY}/${{ matrix.image }}"

          if [[ "${{ matrix.kind }}" == "ui" ]]; then
            BASE_URL="${{ matrix.base_url }}"
            if [[ -z "${BASE_URL}" ]]; then
              echo "::error title=Missing base URL::Set repo variables TESTING_BASE_URL, STAGING_BASE_URL, PRODUCTION_BASE_URL to absolute origins"; exit 1;
            fi

            TAG_ENV="latest-${{ matrix.env_name }}"
            DATE_ENV_TAG="${DATE_TAG}-${{ matrix.env_name }}"

            docker build \
                --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba \
                --build-arg NEXT_PUBLIC_MFA_METHODS_ENABLED=email \
                --build-arg NEXT_PUBLIC_MFA_ALLOW_DISABLE_ALL=false \
                --build-arg NEXT_PUBLIC_BACKEND_URL="${BASE_URL}/api/core/" \
                --build-arg NEXT_PUBLIC_API_URL="${BASE_URL}" \
                --build-arg NEXT_PUBLIC_AUTH_API_URL="${BASE_URL}/auth-api" \
                -f "${{ matrix.dockerfile }}" \
                -t "${IMAGE}:${TAG_ENV}" \
                -t "${IMAGE}:${DATE_ENV_TAG}" \
                "${{ matrix.context }}"

            docker push "${IMAGE}:${TAG_ENV}"
            docker push "${IMAGE}:${DATE_ENV_TAG}"

          else
            docker build \
                -f "${{ matrix.dockerfile }}" \
                -t "${IMAGE}:latest" \
                -t "${IMAGE}:${DATE_TAG}" \
                "${{ matrix.context }}"

            docker push "${IMAGE}:latest"
            docker push "${IMAGE}:${DATE_TAG}"
          fi
