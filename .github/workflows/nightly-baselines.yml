name: Nightly Baselines
on:
    schedule:
        - cron: "15 3 * * *"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build-baselines:
        runs-on: ubuntu-latest
        env:
            ECR_REGISTRY: ${{ secrets.TGCS_ECR_REGISTRY }}
            DATE_TAG: baseline-${{ github.run_id }}
        strategy:
            matrix:
                include:
                    - name: ui
                      repo_path: apps/toshiba
                      dockerfile: apps/toshiba/Dockerfile
                      image: elevaite-toshiba-ui
                      context: .
                    - name: api
                      repo_path: python_apps/toshiba_backends/toshiba_backend
                      dockerfile: python_apps/toshiba_backends/toshiba_backend/Dockerfile
                      image: elevaite-toshiba-backend
                      context: python_apps/toshiba_backends/toshiba_backend
                    - name: auth
                      repo_path: python_apps/auth_api
                      dockerfile: python_apps/auth_api/Dockerfile
                      image: elevaite-auth-api
                      context: .
                    - name: sql-retriever
                      repo_path: python_apps/toshiba_backends/sql_retriever
                      dockerfile: python_apps/toshiba_backends/sql_retriever/Dockerfile
                      image: elevaite-toshiba-sql-retriever
                      context: python_apps/toshiba_backends/sql_retriever
                    - name: tgcs-retriever
                      repo_path: python_apps/toshiba_backends/tgcs_retriever
                      dockerfile: python_apps/toshiba_backends/tgcs_retriever/Dockerfile
                      image: elevaite-toshiba-tgcs-retriever
                      context: python_apps/toshiba_backends/tgcs_retriever
                    - name: topgun-retriever
                      repo_path: python_apps/toshiba_backends/top_gun_retriever
                      dockerfile: python_apps/toshiba_backends/top_gun_retriever/Dockerfile
                      image: elevaite-toshiba-topgun-retriever
                      context: python_apps/toshiba_backends/top_gun_retriever
                    - name: power-retriever
                      repo_path: python_apps/toshiba_backends/power_retriever
                      dockerfile: python_apps/toshiba_backends/power_retriever/Dockerfile
                      image: elevaite-toshiba-power-retriever
                      context: python_apps/toshiba_backends/power_retriever
        steps:
            - uses: actions/checkout@v4

            - uses: docker/setup-buildx-action@v3

            - uses: aws-actions/configure-aws-credentials@v3
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ${{ secrets.STAGE_AWS_REGION }}

            - uses: aws-actions/amazon-ecr-login@v1
            - name: Build & push ${{ matrix.name }}
              run: |
                set -euo pipefail
                IMAGE="${ECR_REGISTRY}/${{ matrix.image }}"

                if [[ "${{ matrix.name }}" == "ui" ]]; then
                    BUILD_ARGS=(
                      --build-arg NEXT_PUBLIC_AUTH_TENANT_ID=toshiba
                      --build-arg NEXT_PUBLIC_MFA_METHODS_ENABLED=email
                      --build-arg NEXT_PUBLIC_MFA_ALLOW_DISABLE_ALL=false
                      --build-arg NEXT_PUBLIC_BACKEND_URL=/api/core/
                      --build-arg NEXT_PUBLIC_AUTH_API_URL=/auth-api
                    )
                else
                    BUILD_ARGS=()
                fi

                docker build \
                    "${BUILD_ARGS[@]}" \
                    -f "${{ matrix.dockerfile }}" \
                    -t "${IMAGE}:latest" \
                    -t "${IMAGE}:${DATE_TAG}" \
                    "${{ matrix.context }}"

                docker push "${IMAGE}:latest"
                docker push "${IMAGE}:${DATE_TAG}"
