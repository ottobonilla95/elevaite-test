# Elevaite Platform - Deploy to Staging
# Automatically deploys to staging environment on merge to develop
# Can also be triggered manually

name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all, auth-api, workflow-engine, ingestion)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - auth-api
          - workflow-engine
          - ingestion

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

jobs:
  # ============================================================
  # BUILD AND PUSH IMAGES
  # ============================================================
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: auth-api
            dockerfile: python_apps/auth_api/Dockerfile
            image: elevaite-auth-api
          - service: workflow-engine
            dockerfile: python_apps/workflow-engine-poc/Dockerfile
            image: elevaite-workflow-engine
          - service: ingestion
            dockerfile: python_apps/ingestion-service/Dockerfile
            image: elevaite-ingestion

    steps:
      - uses: actions/checkout@v4

      - name: Check if service should be deployed
        id: check
        run: |
          if [[ "${{ github.event.inputs.service }}" == "all" ]] || \
             [[ "${{ github.event.inputs.service }}" == "${{ matrix.service }}" ]] || \
             [[ "${{ github.event_name }}" == "push" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        if: steps.check.outputs.should_deploy == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        if: steps.check.outputs.should_deploy == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push ${{ matrix.service }}
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          IMAGE_TAG="${{ env.ECR_REGISTRY }}/${{ matrix.image }}:staging-${{ github.sha }}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/${{ matrix.image }}:staging-latest"

          docker build \
            -f ${{ matrix.dockerfile }} \
            -t $IMAGE_TAG \
            -t $IMAGE_LATEST \
            .

          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST

          echo "Pushed ${{ matrix.service }} to ECR"

  # ============================================================
  # DEPLOY TO STAGING
  # Add your deployment steps here (ECS, K8s, etc.)
  # ============================================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to staging environment
        run: |
          echo "Deploying to staging..."
          echo "Images pushed with tag: staging-${{ github.sha }}"
          echo ""
          echo "TODO: Add deployment steps for your infrastructure"
          echo "Options:"
          echo "  - AWS ECS: Use aws-actions/amazon-ecs-deploy-task-definition"
          echo "  - Kubernetes: Use kubectl or helm"
          echo "  - Custom: Add your deployment script"

      # Example ECS deployment (uncomment and configure):
      # - name: Deploy to ECS
      #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      #   with:
      #     task-definition: task-definition.json
      #     service: elevaite-staging
      #     cluster: elevaite-cluster
      #     wait-for-service-stability: true

  # ============================================================
  # NOTIFY
  # ============================================================
  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify deployment status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "Staging deployment successful"
          else
            echo "Staging deployment failed"
            exit 1
          fi
